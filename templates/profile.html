<!-- templates/profile.html -->

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ trainer.tname }} 트레이너 프로필</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/background.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="trainer-section">
            <div class="trainer-left">
                <div class="image-carousel">
                    {% for src in image_sources %}
                        <img class="carousel-img {% if not loop.first %}hidden{% endif %}" src="{{ src }}">
                    {% endfor %}
                    {% if image_sources|length > 1 %}
                        <button class="carousel-btn left" onclick="prevImage()">&#10094;</button>
                        <button class="carousel-btn right" onclick="nextImage()">&#10095;</button>
                    {% endif %}
                </div>
            </div>
            <br>
            <div class="trainer-right">
                <h2>{{ trainer.tname }} 트레이너</h2>
                <div class="trainer-intro">{{ trainer.introduce | safe }}</div>
                <br>
                <form action="/consult" method="get">
                    <input type="hidden" name="trainer_id" value="{{ trainer_id }}">
                    <button class="consult-btn">💬 상담 신청하기</button>
                </form>

                {% if is_admin %}
                    <br>
                    <button class="edit-btn">프로필 수정하기</button>
                    <br><br>
                {% endif %}
            </div>
        </div>

        <br><hr>

        <section class="stats-section">
            <h3>지난 달 실제 등록 회원</h3>
            <div class="chart-container">
                <canvas id="genderChart"></canvas>
                <canvas id="ageChart"></canvas>
            </div>
        </section>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            let current = 0;
            const images = document.querySelectorAll('.carousel-img');

            function showImage(index) {
                images.forEach((img, i) => {
                img.classList.toggle('hidden', i !== index);
                });
            }

            function prevImage() {
                current = (current - 1 + images.length) % images.length;
                showImage(current);
            }

            function nextImage() {
                current = (current + 1) % images.length;
                showImage(current);
            }
        </script>
        <script>
            const genderData = JSON.parse('{{ gender_data | tojson | safe }}');
            const ageData = JSON.parse('{{ age_data | tojson | safe }}');
        
            // 성별 비율 차트
            new Chart(document.getElementById('genderChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(genderData),
                        datasets: [{
                            data: Object.values(genderData),
                            backgroundColor: ['#4BC0C0', '#FF6384'],
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

            // 나이대 막대 그래프
            new Chart(document.getElementById('ageChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(ageData),
                    datasets: [{
                        label: '연령 비율 (%)',
                        data: Object.values(ageData),
                        backgroundColor: '#FF9F40'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        </script>
        
        <br><hr>

        <!-- 후기 요약 -->
        <section class="review-summary">
            <p>
                후기 <span class="summary-star">★</span>
                {{ avg_rating }} (총 {{ review_count }}개)
            </p>
            <!-- 추후 정렬 기능 구현 시 -->
            <!-- 필터 버튼 자리 예약 -->
        </section>

        <!-- 후기 작성 -->
        <section class="review-form">
            <h4>리뷰 작성하기</h4>
            <form method="POST">
                <label>별점:
                    <select name="rating">
                        {% for i in range(5, 0, -1) %}
                            <option value="{{ i }}">{{ i }}점</option>
                        {% endfor %}
                    </select>
                </label>
                <br><br>
                <label>후기:</label><br>
                <textarea name="review" rows="4" cols="50" required></textarea><br><br>
                <button type="submit" class="submit-btn">리뷰 등록</button>
            </form>
        </section>

        <!-- 후기 리스트 -->
        <section class="review-list">
            {% for review in reviews %}
                <div class="review-card">
                    <p class="review-meta">
                        {{ review.login_id[:-3] + '***' }} | {{ review.created_at.strftime('%Y-%m-%d') }}
                    </p>
                    <p class="review-stars">
                        <span class="star-yellow">{{ '★' * review.rating }}{{ '☆' * (5 - review.rating) }}</span>
                        <span class="review-score">{{ review.rating }}</span>
                    </p>
                    <p>{{ review.comment }}</p>
                </div>
            {% endfor %}
        </section>
    </div>
</body>
</html>
