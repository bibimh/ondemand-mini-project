<!-- templates/profile.html -->

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ trainer.tname }} íŠ¸ë ˆì´ë„ˆ í”„ë¡œí•„</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/background.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="trainer-section">
            <div class="trainer-left">
                <div class="image-carousel">
                    <div class="carousel-track">
                        {% for src in image_sources %}
                            <img class="carousel-img" src="{{ src }}">
                        {% endfor %}
                    </div>
                    {% if image_sources|length > 1 %}
                        <button class="carousel-btn left" onclick="prevImage()">&#10094;</button>
                        <button class="carousel-btn right" onclick="nextImage()">&#10095;</button>
                    {% endif %}
                </div>
            </div>
            <br>
            <div class="trainer-right">
                <h2>{{ trainer.tname }} íŠ¸ë ˆì´ë„ˆ</h2>
                <div class="trainer-intro">{{ trainer.introduce | safe }}</div>
                <br>
                <form action="/consult" method="get">
                    <input type="hidden" name="trainer_id" value="{{ trainer_id }}">
                    <button class="consult-btn">ğŸ’¬ ìƒë‹´ ì‹ ì²­í•˜ê¸°</button>
                </form>

                {% if is_admin %}
                    <br>
                    <a href="{{ url_for('edit_profile.edit_profile', trainer_id=trainer_id) }}">
                        <button class="edit-btn">í”„ë¡œí•„ ìˆ˜ì •í•˜ê¸°</button>
                    </a>                    
                    <br><br>
                {% endif %}
            </div>
        </div>

        <br><hr>

        <section class="stats-section">
            <h3>ì§€ë‚œ ë‹¬ ì‹¤ì œ ë“±ë¡ íšŒì›</h3>
            <div class="chart-container">
                <div style="width: 240px; height: 240px;">
                    <canvas id="genderChart"></canvas>
                </div>
                <div style="width: 320px; height: 240px;">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>
        </section>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            let current = 0;
            const track = document.querySelector('.carousel-track');
            const images = document.querySelectorAll('.carousel-img');
            const total = images.length;

            const btnLeft = document.querySelector('.carousel-btn.left');
            const btnRight = document.querySelector('.carousel-btn.right');

            function updateSlide() {
                const container = document.querySelector('.image-carousel');
                const track = document.querySelector('.carousel-track');
                const images = document.querySelectorAll('.carousel-img');
                const containerWidth = container.offsetWidth;

                track.style.width = `${containerWidth * total}px`;
                track.style.transform = `translateX(-${current * containerWidth}px)`;

                images.forEach(img => {
                    img.style.width = `${containerWidth}px`;  // ì´ë¯¸ì§€ í¬ê¸° í†µì¼
                    img.style.flex = '0 0 auto';              // ì¶•ì†Œ ë°©ì§€
                });

                if (btnLeft) btnLeft.disabled = current === 0;
                if (btnRight) btnRight.disabled = current === total - 1;
            }

            function prevImage() {
                if (current > 0) {
                    current--;
                    updateSlide();
                }
            }

            function nextImage() {
                if (current < total - 1) {
                    current++;
                    updateSlide();
                }
            }

            window.addEventListener('load', updateSlide);
            window.addEventListener('resize', updateSlide);
        </script>


        <script>
            const genderData = JSON.parse('{{ gender_data | tojson | safe }}');
            const ageData = JSON.parse('{{ age_data | tojson | safe }}');

            // ì„±ë³„ ë„ë„›í˜• ê·¸ë˜í”„
            new Chart(document.getElementById('genderChart'), {
                type: 'doughnut',
                data: {
                    labels: ['ë‚¨', 'ì—¬'],
                    datasets: [{
                        data: [genderData['M'] || 0, genderData['F'] || 0],
                        backgroundColor: ['#4BC0C0', '#FF6384'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 14 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed}%`;
                                }
                            }
                        }
                    }
                }
            });

            // ì—°ë ¹ëŒ€ë³„ ë§‰ëŒ€ ê·¸ë˜í”„
            new Chart(document.getElementById('ageChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(ageData),  // ['10ëŒ€', '20ëŒ€', ...]
                    datasets: [{
                        data: Object.values(ageData),
                        backgroundColor: '#36A2EB',
                        barThickness: 25
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;  // â† í¼ì„¼íŠ¸ ê°’ (ìˆ«ì)
                                    return `${value}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { font: { size: 13 } }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { stepSize: 20 }
                        }
                    }
                }
            });

        </script>
        
        <br><hr>

        <!-- í›„ê¸° ìš”ì•½ -->
        <section class="review-summary">
            <p>
                í›„ê¸° <span class="summary-star">â˜…</span>
                {{ avg_rating }} (ì´ {{ review_count }}ê°œ)
            </p>
            <!-- ì¶”í›„ ì •ë ¬ ê¸°ëŠ¥ êµ¬í˜„ ì‹œ -->
            <!-- í•„í„° ë²„íŠ¼ ìë¦¬ ì˜ˆì•½ -->
        </section>

        <!-- í›„ê¸° ì‘ì„± -->
        <section class="review-form">
            <h4>ë¦¬ë·° ì‘ì„±í•˜ê¸°</h4>
            <form method="POST">
                <label>ë³„ì :
                    <select name="rating">
                        {% for i in range(5, 0, -1) %}
                            <option value="{{ i }}">{{ i }}ì </option>
                        {% endfor %}
                    </select>
                </label>
                <br><br>
                <label>í›„ê¸°:</label><br>
                <textarea name="review" rows="4" cols="50" required></textarea><br><br>
                <button type="submit" class="submit-btn">ë¦¬ë·° ë“±ë¡</button>
            </form>
        </section>

        <!-- í›„ê¸° ë¦¬ìŠ¤íŠ¸ -->
        <section class="review-list">
            {% for review in reviews %}
                <div class="review-card">
                    <p class="review-meta">
                        {{ review.login_id[:-3] + '***' }} | {{ review.created_at.strftime('%Y-%m-%d') }}
                    </p>
                    <p class="review-stars">
                        <span class="star-yellow">{{ 'â˜…' * review.rating }}{{ 'â˜†' * (5 - review.rating) }}</span>
                        <span class="review-score">{{ review.rating }}</span>
                    </p>
                    <p>{{ review.comment }}</p>
                </div>
            {% endfor %}
        </section>
    </div>
</body>
</html>
