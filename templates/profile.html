<!-- templates/profile.html -->

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ trainer.tname }} íŠ¸ë ˆì´ë„ˆ í”„ë¡œí•„</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/background.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
    <!-- íŠ¸ë ˆì´ë„ˆ ì •ë³´ -->
    <div class="trainer-section">
        <div class="trainer-left">
            <div class="image-carousel">
                <div class="carousel-track">
                    {% for src in image_sources %}
                        <img class="carousel-img" src="{{ src }}">
                    {% endfor %}
                </div>
                {% if image_sources|length > 1 %}
                    <button class="carousel-btn left" onclick="prevImage()">&#10094;</button>
                    <button class="carousel-btn right" onclick="nextImage()">&#10095;</button>
                {% endif %}
            </div>
        </div>
        <br>
        <div class="trainer-right">
            <h2>{{ trainer.tname }} íŠ¸ë ˆì´ë„ˆ</h2>
            <div class="trainer-intro">{{ trainer.introduce | safe }}</div>
            <br>
            {% if not is_admin %}
                <form action="/consult" method="get">
                    <input type="hidden" name="trainer_id" value="{{ trainer_id }}">
                    <button class="consult-btn">ğŸ’¬ ìƒë‹´ ì‹ ì²­í•˜ê¸°</button>
                </form>
            {% endif %}

            {% if is_admin %}
                <br>
                <a href="{{ url_for('edit_profile.edit_profile', trainer_id=trainer_id) }}">
                    <button class="edit-btn">ğŸ– í”„ë¡œí•„ ìˆ˜ì •í•˜ê¸°</button>
                </a>
                <br> <br>
                <a href="{{ url_for('consultation.admin_consultations') }}?trainer_id={{ trainer_id }}">
                    <button class="edit-btn">ğŸ“‹ ìƒë‹´ ì˜ˆì•½ í˜„í™© ë³´ê¸°</button>
                </a>
                <br><br>
            {% endif %}
        </div>
    </div>

    <br><hr>

    <!-- í†µê³„ -->
    <section class="stats-section">
        <h3>ì§€ë‚œ ë‹¬ ì‹¤ì œ ë“±ë¡ íšŒì›</h3>
        <div class="chart-container">
            <div style="width: 240px; height: 240px;">
                <canvas id="genderChart"></canvas>
            </div>
            <div style="width: 320px; height: 240px;">
                <canvas id="ageChart"></canvas>
            </div>
        </div>
    </section>

    <br><hr>

    <!-- ë¦¬ë·° í†µê³„ -->
    <section class="review-summary">
        <p>
            í›„ê¸° <span class="summary-star">â˜…</span>
            {{ avg_rating }} (ì´ {{ review_count }}ê°œ)
        </p>
    </section>

    <!-- ë¦¬ë·° ì‘ì„± -->
    <section class="review-form">
        <h4>ë¦¬ë·° ì‘ì„±í•˜ê¸°</h4>

        {% if not session['user_id'] %}
            <p>âœ‹ ë¡œê·¸ì¸ í›„ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

        {% elif is_admin %}
            <p>ğŸš« ê´€ë¦¬ìëŠ” ë¦¬ë·°ë¥¼ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>

        {% elif is_registered %}
            <form method="POST">
                <label>ë³„ì :
                    <select name="rating">
                        {% for i in range(5, 0, -1) %}
                            <option value="{{ i }}">{{ i }}ì </option>
                        {% endfor %}
                    </select>
                </label><br><br>
                <label>í›„ê¸°:</label><br>
                <textarea name="review" rows="4" cols="50" required></textarea><br><br>
                <button type="submit" class="submit-btn">ë¦¬ë·° ë“±ë¡</button>
            </form>

        {% else %}
            <p>ğŸ˜¢ í•´ë‹¹ íŠ¸ë ˆì´ë„ˆëŠ” íšŒì›ë‹˜ì˜ ë‹´ë‹¹ íŠ¸ë ˆì´ë„ˆê°€ ì•„ë‹™ë‹ˆë‹¤. ë¦¬ë·°ë¥¼ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </section>

    <!-- ë¦¬ë·° ì •ë ¬ -->
    <div style="text-align: right; margin-bottom: 10px;">
        <div class="sort-box">
            <label for="sort" class="sort-label">ì •ë ¬:</label>
            <select id="sort" class="sort-select" onchange="changeSort()">
                <option value="latest" {% if sort == 'latest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
                <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>ì˜¤ë˜ëœìˆœ</option>
                <option value="high" {% if sort == 'high' %}selected{% endif %}>ë³„ì  ë†’ì€ìˆœ</option>
                <option value="low" {% if sort == 'low' %}selected{% endif %}>ë³„ì  ë‚®ì€ìˆœ</option>
            </select>
        </div>
    </div>

    <!-- ë¦¬ë·° ëª©ë¡ -->
    <section class="review-list" id="review-list">
        {% include 'partials/review_list.html' %}
    </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const genderData = JSON.parse('{{ gender_data | tojson | safe }}');
    const ageData = JSON.parse('{{ age_data | tojson | safe }}');

    new Chart(document.getElementById('genderChart'), {
        type: 'doughnut',
        data: {
            labels: ['ë‚¨', 'ì—¬'],
            datasets: [{
                data: [genderData['M'] || 0, genderData['F'] || 0],
                backgroundColor: ['#4BC0C0', '#FF6384'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.parsed}%`;
                        }
                    }
                }
            }
        }
    });

    new Chart(document.getElementById('ageChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(ageData),
            datasets: [{
                data: Object.values(ageData),
                backgroundColor: '#36A2EB',
                barThickness: 25
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.raw}%`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20,
                        callback: value => value + '%'
                    }
                }
            }
        }
    });

    // ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë“œ ê´€ë ¨ (ìƒëµ ê°€ëŠ¥)
    let current = 0;
    const track = document.querySelector('.carousel-track');
    const images = document.querySelectorAll('.carousel-img');
    const total = images.length;

    function updateSlide() {
        const container = document.querySelector('.image-carousel');
        const containerWidth = container.offsetWidth;
        track.style.width = `${containerWidth * total}px`;
        track.style.transform = `translateX(-${current * containerWidth}px)`;
        images.forEach(img => {
            img.style.width = `${containerWidth}px`;
            img.style.flex = '0 0 auto';
        });
    }

    function prevImage() {
        if (current > 0) {
            current--;
            updateSlide();
        }
    }

    function nextImage() {
        if (current < total - 1) {
            current++;
            updateSlide();
        }
    }

    window.addEventListener('load', updateSlide);
    window.addEventListener('resize', updateSlide);

    // ìƒˆë¡œê³ ì¹¨ ì‹œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ê¸°ì–µ
    window.addEventListener('beforeunload', function () {
        localStorage.setItem('scrollPosition', window.scrollY);
    });

    // ë¡œë“œë˜ë©´ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
    window.addEventListener('load', function () {
        const scrollY = localStorage.getItem('scrollPosition');
        if (scrollY !== null) {
            window.scrollTo(0, parseInt(scrollY));
            localStorage.removeItem('scrollPosition');
        }
    });

    // ì •ë ¬ select ë³€ê²½ ì‹œ í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ìœ ì§€í•˜ë©° ìƒˆë¡œê³ ì¹¨
    function changeSort() {
        const sort = document.getElementById('sort').value;
        const trainerId = "{{ trainer_id }}";

        fetch(`/profile/${trainerId}/reviews?sort=${sort}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('review-list').innerHTML = data.html;

                // URLì— ì •ë ¬ê°’ ë°˜ì˜ (ë’¤ë¡œê°€ê¸° ì‹œì—ë„ ë°˜ì˜ë¨)
                history.replaceState(null, '', `?sort=${sort}`);
            })
            .catch(error => console.error("ë¦¬ë·° ì •ë ¬ ì˜¤ë¥˜:", error));
    }
</script>
</body>
</html>